---

name: Notify PRs about master Build
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

defaults:
  run:
    shell: bash

jobs:
  check_master_build_status:
    name: Check master Build status
    runs-on: ubuntu-latest
    env:
      CURRENT_PR_NUMBER: ${{ github.event.pull_request.number }}
      BUILD_AND_TEST_WORKFLOW_ID: 51575223
      SEARCH_PAGE_LIMIT: 5
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
        with:
          sparse-checkout: .github

      - uses: actions/github-script@v6
        with:
          script: |
            console.log("Fetching the latest 10 completed master branch server_build_and_test Github Workflows.")
            
            const {BUILD_AND_TEST_WORKFLOW_ID, SEARCH_PAGE_LIMIT} = process.env
            let { data } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: BUILD_AND_TEST_WORKFLOW_ID,
                  branch: 'master',
                  event: 'push',
                  per_page: 10,
                  status: 'completed'
                });
            if(data.total_count == 0){
              console.log(`No builds found`)
              return
            }
            let LATEST_WORKFLOW_RUN_CONCLUSION = data.workflow_runs[0].conclusion
            console.log(`The latest master build and test was completed with status: ${LATEST_WORKFLOW_RUN_CONCLUSION}`)
            
            let MESSAGE = `‚ÑπÔ∏è Checking the current Master Branch Build status...  \n`
            
            switch(LATEST_WORKFLOW_RUN_CONCLUSION) {
              case 'failure':
            
                console.log("Determining the first failure of pipeline run for master branch build and test.")    
                let PAGE = 1
                while(data.workflow_runs[9].conclusion == 'failure' && PAGE <= SEARCH_PAGE_LIMIT) {
                  console.log(`Searching for previous 10 failure runs, fetching with page number ${PAGE}...`)
                  let { data } = await github.rest.actions.listWorkflowRuns({
                                    owner: context.repo.owner,
                                    repo: context.repo.repo,
                                    workflow_id: BUILD_AND_TEST_WORKFLOW_ID,
                                    branch: 'master',
                                    event: 'push',
                                    per_page: 10,
                                    status: 'completed',
                                    page: PAGE
                                  });
                  ++PAGE
                  currentWorkflowRun = data
                }
                if(PAGE > SEARCH_PAGE_LIMIT){
                  console.log(`There are multiple failures on master build. Please contact #tm_monolith team`)
                  MESSAGE += " ‚ö†Ô∏è There are more than 50 build failures. Please contact #tm_monolith team. Attaching sample build failure. ‚ö†Ô∏è "
                }
            
               
                
                console.log(`First failure for the master branch build and test was ${FIRST_FAILURE_RUN_BEFORE_SUCCESS.html_url}. Finding failing step...`) 
                await github.rest.actions.listJobsForWorkflowRun({
                       owner: context.repo.owner,
                       repo: context.repo.repo,
                       run_id: FIRST_FAILURE_RUN_BEFORE_SUCCESS.id
                      })
                      .then(data => {
                          let fail_job = data.data.jobs.find((x,i) => x.conclusion == 'failure');
                          console.log(`Failing step for first master branch build found: ${fail_job.html_url}`)
                          MESSAGE += ` üö® The master build is failing at job [link](${fail_job.html_url}) and for commit_sha ${fail_job.head_sha}. Try reaching out author ${FIRST_FAILURE_RUN_BEFORE_SUCCESS.actor.login} üö® `
                      })
                
                const {CURRENT_PR_NUMBER} = process.env
                console.log(`Appending: ${MESSAGE} :to the PR ${CURRENT_PR_NUMBER}`)
                github.rest.issues.createComment({
                  issue_number: CURRENT_PR_NUMBER,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: MESSAGE,
                })
            
                break;
              case 'success':
                console.log("master builds are successful.")
                break;
              default:
                console.log("Could not determine latest workflow run conclusion")
            }
